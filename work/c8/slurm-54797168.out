slurmstepd: error: IPMI failure detected, energy reading for this step will not be accurate.
SLURMD_NODENAME = hpc-33-16
Start time = Wed Nov 12 04:53:13 PM PST 2025
CUDA_VISIBLE_DEVICES = 0
OMP_NUM_THREADS = 32
MKL_NUM_THREADS = 4
OPENBLAS_NUM_THREADS = 4
PYSCF_MAX_MEMORY = 327680
TMPDIR = /resnick/scratch/yangjunjie//gpu4pyscf-occri/54797168/
PYSCF_TMPDIR = /resnick/scratch/yangjunjie//gpu4pyscf-occri/54797168/
Using GPU device 0
Free memory: 78.68 GB
Total memory: 79.19 GB
#INFO: **** input file is /resnick/groups/changroup/members/junjiey/occri-main/work/c8/main.py ****
import cupy as cp

device = cp.cuda.Device()
print(f"Using GPU device {device.id}")
mem_info = cp.cuda.runtime.memGetInfo()
print(f"Free memory: {mem_info[0] / (1024**3):.2f} GB")
print(f"Total memory: {mem_info[1] / (1024**3):.2f} GB")

import pyscf, gpu4pyscf
from pyscf.pbc import gto
import gpu4pyscf.pbc
from gpu4pyscf.pbc.df import fft_jk

pcell = gto.Cell()
pcell.a = '''
3.5668  0.0000  0.0000
0.0000  3.5668  0.0000
0.0000  0.0000  3.5668
'''
pcell.atom = '''
C     0.0000  0.0000  0.0000    
C     0.8917  0.8917  0.8917
C     1.7834  1.7834  0.0000    
C     2.6751  2.6751  0.8917
C     1.7834  0.0000  1.7834
C     2.6751  0.8917  2.6751
C     0.0000  1.7834  1.7834
C     0.8917  2.6751  2.6751
'''
pcell.basis = 'gth-dzvp'
pcell.pseudo = 'gth-hf-rev'
pcell.verbose = 4
pcell.ke_cutoff = 100
pcell.exp_to_discard = 0.1
pcell.build()

kpts = pcell.make_kpts([4, 4, 4])

from gpu4pyscf.pbc.scf import KRHF, KUHF
mf = KRHF(pcell, kpts)
# mf = KUHF(pcell, kpts)
mf.verbose = 5
mf.conv_tol = 1e-6
mf.max_cycle = 10
mf.exxdiv = None
dm0 = mf.get_init_guess(key='minao')

mf.kernel(dm0)
ene_ref = mf.e_tot

import numpy as np
from pyscf import lib
from pyscf.pbc.lib.kpts_helper import is_zero, member
from pyscf.pbc.df.df_jk import _format_kpts_band
from gpu4pyscf.lib.cupy_helper import contract
from gpu4pyscf.pbc import tools

from gpu4pyscf.pbc.df.df_jk import _format_dms, _format_jks
from gpu4pyscf.lib import logger, utils

def get_k_kpts_v1(mydf, dm_kpts, hermi=1, kpts=np.zeros((1,3)), kpts_band=None,
                  exxdiv=None):
    cell = mydf.cell
    mesh = mydf.mesh
    assert cell.low_dim_ft_type != 'inf_vacuum'
    assert cell.dimension > 1
    coords = mydf.grids.coords
    ngrids = coords.shape[0]

    if getattr(dm_kpts, 'mo_coeff', None) is not None:
        mo_coeff = dm_kpts.mo_coeff
        mo_occ   = dm_kpts.mo_occ
    else:
        mo_coeff = None

    ni = mydf._numint
    kpts = np.asarray(kpts)
    dm_kpts = cp.asarray(dm_kpts, order='C')
    dms = _format_dms(dm_kpts, kpts)
    nset, nkpts, nao = dms.shape[:3]

    weight = (cell.vol / ngrids) / nkpts 

    kpts_band, input_band = _format_kpts_band(kpts_band, kpts), kpts_band
    nband = len(kpts_band)

    dtype = np.complex128
    if is_zero(kpts_band) and is_zero(kpts):
        dtype = dms.dtype
    vk_kpts = cp.zeros((nset, nband, nao, nao), dtype=dtype)

    # calculate the size of ao1_kpts
    size = nkpts * nao * ngrids * 16 / 1e9
    print("nkpts = %d, nao = %d, ngrids = %6.2e" % (nkpts, nao, ngrids))
    print("Size of ao1_kpts: %6.2e GB" % size)
    
    from gpu4pyscf.lib.cupy_helper import get_avail_mem
    mem = get_avail_mem() / 1e9
    print("Available memory: %6.2e GB" % mem)

    ao2_kpts = ni.eval_ao(cell, coords, kpts=kpts)
    ao1_kpts = ao2_kpts if input_band is None else ni.eval_ao(cell, coords, kpts=kpts_band)

    if mo_coeff is not None and nset == 1:
        mo2_kpts = [
            ao.dot(mo[:,occ>0] * occ[occ>0]**.5)
            for occ, mo, ao in zip(mo_occ, mo_coeff, ao2_kpts)]
        ao2_kpts = mo2_kpts
    else:
        mo2_kpts = None

    blksize = 32
    vr_dm = cp.zeros((nao, ngrids), dtype=dtype)
    for s in range(nset):
        for k1, ao1 in enumerate(ao1_kpts):
            ao1T = ao1.T # shape (ngrids, naoi)
            kpt1 = kpts_band[k1]
            vr_dm *= 0.0
            
            for k2, ao2 in enumerate(ao2_kpts):
                ao2T = ao2.T
                kpt2 = kpts[k2]

                k21 = kpt2 - kpt1
                coulg = tools.get_coulG(cell, k21, False, mydf, mesh)

                if not is_zero(k21):
                    k21 = cp.asarray(k21)
                    theta = cp.dot(coords, k21)
                    phase = cp.exp(-1j * theta)
                    ao2T = ao2T * phase.reshape(1, -1)

                ao_dm = cp.dot(dms[s, k2], ao2T.conj()) if mo2_kpts is None else ao2T.conj()

                for i0, i1 in lib.prange(0, nao, blksize):
                    rhoR = contract('ig,jg->ijg', ao1T[i0:i1].conj(), ao2T)
                    rhoR = rhoR.reshape(-1, ngrids)

                    rhoG = tools.fft(rhoR, mesh)
                    vG = rhoG * coulg
                    # rhoR = rhoG = None

                    vR = tools.ifft(vG, mesh).reshape(i1-i0, -1, ngrids)
                    vr_dm[i0:i1] += contract('ijg,jg->ig', vR, ao_dm)
                    # vR = vG = None

            vk_kpts[s, k1] += weight * cp.dot(vr_dm, ao1)

    if exxdiv == 'ewald':
        from gpu4pyscf.pbc.df.df_jk import _ewald_exxdiv_for_G0
        vk_kpts = _ewald_exxdiv_for_G0(cell, kpts, dms, vk_kpts, kpts_band=kpts_band)

    return _format_jks(vk_kpts, dm_kpts, input_band, kpts)

# fft_jk.get_k_kpts = get_k_kpts_v1
# mf.kernel(dm0)
# ene_ref = mf.e_tot

# print("ene_ref = %12.6f" % ene_ref)
# print("ene_sol = %12.6f" % ene_sol)
# print("error   = %6.2e" % abs(ene_ref - ene_sol))

def get_k_kpts_v2(mydf, dm_kpts, hermi=1, kpts=np.zeros((1,3)), 
                        kpts_band=None, exxdiv=None):
    cell = mydf.cell
    mesh = mydf.mesh
    assert cell.low_dim_ft_type != 'inf_vacuum'
    assert cell.dimension > 1
    coords = mydf.grids.coords
    ngrids = coords.shape[0]

    if getattr(dm_kpts, 'mo_coeff', None) is not None:
        mo_coeff = dm_kpts.mo_coeff
        mo_occ   = dm_kpts.mo_occ
    else:
        mo_coeff = None

    ni = mydf._numint
    kpts = np.asarray(kpts)
    dm_kpts = cp.asarray(dm_kpts, order='C')
    dms = _format_dms(dm_kpts, kpts)
    nset, nkpts, nao = dms.shape[:3]

    weight = (cell.vol / ngrids) / nkpts 

    kpts_band, input_band = _format_kpts_band(kpts_band, kpts), kpts_band
    nband = len(kpts_band)

    dtype = np.complex128
    if is_zero(kpts_band) and is_zero(kpts):
        dtype = dms.dtype
    vk_kpts = cp.zeros((nset, nband, nao, nao), dtype=dtype)

    if mo_coeff is not None and mo_occ is not None:
        mo_coeff = cp.asarray(mo_coeff).reshape(nset, nkpts, nao, -1)
        mo_occ = cp.asarray(mo_occ).reshape(nset, nkpts, -1)

    blksize = 32
    vr_dm = cp.zeros((nao, ngrids), dtype=dtype)

    from gpu4pyscf.pbc.dft.numint import eval_ao
    for s in range(nset):
        for k1 in range(nband):
            kpt1 = kpts_band[k1]
            ao1 = eval_ao(cell, coords, kpt=kpt1)
            ao1T = ao1.T
            # ao1 shape (ngrids, nao)
            # ao1T shape (nao, ngrids)

            vr_dm *= 0.0
            
            for k2 in range(nkpts):
                kpt2 = kpts[k2]
                ao2 = eval_ao(cell, coords, kpt=kpt2)
                
                k21 = kpt2 - kpt1
                coulg = tools.get_coulG(cell, k21, False, mydf, mesh)

                if not is_zero(k21):
                    k21 = cp.asarray(k21)
                    theta = cp.dot(coords, k21)
                    phase = cp.exp(-1j * theta)
                    ao2 = ao2 * phase.reshape(-1, 1)

                if mo_coeff is not None and mo_occ is not None:
                    mask = mo_occ[s, k2] > 0
                    ao_dm = cp.dot(ao2, mo_coeff[s, k2][:, mask] * mo_occ[s, k2][mask] ** 0.5)
                    ao2T = ao_dm.T
                    ao_dm = ao2T.conj()
                else:
                    ao2T = ao2.T 
                    ao_dm = cp.dot(dms[s, k2], ao2T.conj())

                for i0, i1 in lib.prange(0, nao, blksize):
                    rhoR = ao1T[i0:i1].conj().reshape(-1, 1, ngrids) * ao2T.reshape(1, -1, ngrids)
                    rhoR = rhoR.reshape(-1, ngrids)

                    rhoG = tools.fft(rhoR, mesh)
                    vG = rhoG * coulg
                    rhoR = rhoG = None

                    vR = tools.ifft(vG, mesh).reshape(i1-i0, -1, ngrids)
                    vr_dm[i0:i1] += contract('ijg,jg->ig', vR, ao_dm)
                    vR = vG = None

            vk_kpts[s, k1] += weight * cp.dot(vr_dm, ao1)

    if exxdiv == 'ewald':
        from gpu4pyscf.pbc.df.df_jk import _ewald_exxdiv_for_G0
        vk_kpts = _ewald_exxdiv_for_G0(cell, kpts, dms, vk_kpts, kpts_band=kpts_band)

    return _format_jks(vk_kpts, dm_kpts, input_band, kpts)

# fft_jk.get_k_kpts = get_k_kpts_v2
# mf.kernel(dm0)
# ene_sol = mf.e_tot

# print("ene_ref = %12.6f" % ene_ref)
# print("ene_sol = %12.6f" % ene_sol)
# print("error   = %6.2e" % abs(ene_ref - ene_sol))

mf.with_df.ovlp_kpts = mf.get_ovlp()
def get_k_kpts_occri(mydf, dm_kpts, hermi=1, kpts=np.zeros((1,3)), 
                           kpts_band=None, exxdiv=None):
    cell = mydf.cell
    mesh = mydf.mesh
    assert cell.low_dim_ft_type != 'inf_vacuum'
    assert cell.dimension > 1
    coords = mydf.grids.coords
    ngrids = coords.shape[0]

    if getattr(dm_kpts, 'mo_coeff', None) is not None:
        mo_coeff = dm_kpts.mo_coeff
        mo_occ   = dm_kpts.mo_occ
    else:
        mo_coeff = None

    ni = mydf._numint
    kpts = np.asarray(kpts)
    dm_kpts = cp.asarray(dm_kpts, order='C')
    dms = _format_dms(dm_kpts, kpts)
    nset, nkpts, nao = dms.shape[:3]

    weight = (cell.vol / ngrids) / nkpts 

    kpts_band, input_band = _format_kpts_band(kpts_band, kpts), kpts_band
    nband = len(kpts_band)

    dtype = np.complex128
    if is_zero(kpts_band) and is_zero(kpts):
        dtype = dms.dtype
    vk_kpts = cp.zeros((nset, nband, nao, nao), dtype=dtype)

    if mo_coeff is not None and mo_occ is not None:
        mo_coeff = cp.asarray(mo_coeff).reshape(nset, nkpts, nao, -1)
        mo_occ = cp.asarray(mo_occ).reshape(nset, nkpts, -1)
    else:
        return vk_kpts

    blksize = 32

    from gpu4pyscf.pbc.dft.numint import eval_ao
    for s in range(nset):
        for k1 in range(nband):
            kpt1 = kpts_band[k1]
            ao1 = eval_ao(cell, coords, kpt=kpt1)

            mask = mo_occ[s, k1] > 0
            cocc1 = mo_coeff[s, k1][:, mask]
            
            mo1 = cp.dot(ao1, cocc1)
            mo1T = mo1.T.reshape(-1, 1, ngrids)
            nmo1 = mo1T.shape[0]

            vr_dm = cp.zeros((nmo1, ngrids), dtype=dtype)
            for k2 in range(nkpts):
                kpt2 = kpts[k2]
                ao2 = eval_ao(cell, coords, kpt=kpt2)

                k21 = kpt2 - kpt1
                coulg = tools.get_coulG(cell, k21, False, mydf, mesh)

                if not is_zero(k21):
                    k21 = cp.asarray(k21)
                    theta = cp.dot(coords, k21)
                    phase = cp.exp(-1j * theta)
                    ao2 = ao2 * phase.reshape(-1, 1)

                mask = mo_occ[s, k2] > 0
                mo2 = cp.dot(ao2, mo_coeff[s, k2][:, mask] * mo_occ[s, k2][mask] ** 0.5)
                mo2T = mo2.T.reshape(1, -1, ngrids)

                for i0, i1 in lib.prange(0, nmo1, blksize):
                    rhoR = mo1T[i0:i1].conj()* mo2T
                    rhoR = rhoR.reshape(-1, ngrids)

                    rhoG = tools.fft(rhoR, mesh)
                    vG = rhoG * coulg
                    rhoR = rhoG = None

                    vR = tools.ifft(vG, mesh).reshape(i1-i0, -1, ngrids)
                    vr_dm[i0:i1] += contract('ijg,gj->ig', vR, mo2.conj())
                    vR = vG = None

            ovlp1 = mydf.ovlp_kpts[k1]
            cinv1 = cp.dot(ovlp1, cocc1)
            ccinv = cp.dot(cocc1, cinv1.T.conj())
            
            # cinv_vr_dm = cp.dot(cinv1, vr_dm)
            # v1 = cp.dot(cinv_vr_dm, ao1) * weight
            v1 = cp.dot(vr_dm, ao1) * weight
            cinv_v1 = cp.dot(cinv1, v1)

            vk_kpts[s, k1] += cinv_v1 + cinv_v1.T.conj()
            vk_kpts[s, k1] -= cp.dot(cinv_v1, ccinv)

    if exxdiv == 'ewald':
        from gpu4pyscf.pbc.df.df_jk import _ewald_exxdiv_for_G0
        vk_kpts = _ewald_exxdiv_for_G0(cell, kpts, dms, vk_kpts, kpts_band=kpts_band)

    return _format_jks(vk_kpts, dm_kpts, input_band, kpts)

fft_jk.get_k_kpts = get_k_kpts_occri
mf.kernel(dm0)
ene_sol = mf.e_tot

print("ene_ref = %12.6f" % ene_ref)
print("ene_sol = %12.6f" % ene_sol)
print("error   = %6.2e" % abs(ene_ref - ene_sol))
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='hpc-33-16.cm.cluster', release='5.14.0-427.13.1.el9_4.x86_64', version='#1 SMP PREEMPT_DYNAMIC Wed Apr 10 10:29:16 EDT 2024', machine='x86_64')  Threads 32
Python 3.12.12 | packaged by Anaconda, Inc. | (main, Oct 21 2025, 20:16:04) [GCC 11.2.0]
numpy 2.2.6  scipy 1.16.3  h5py 3.15.1
Date: Wed Nov 12 16:53:16 2025
PySCF version 2.8.0
PySCF path  /home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/pyscf/__init__.py
CUDA Environment
    CuPy 13.4.1
    CUDA Path /usr/local/cuda
    CUDA Build Version 12080
    CUDA Driver Version 12080
    CUDA Runtime Version 12080
CUDA toolkit
    cuSolver (11, 7, 3)
    cuBLAS 120804
    cuTENSOR 20200
Device info
    Device name b'NVIDIA H100 80GB HBM3'
    Device global memory 79.19 GB
    CuPy memory fraction 0.9
    Num. Devices 1
GPU4PySCF 1.4.3
GPU4PySCF path  /home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/gpu4pyscf

[ENV] PYSCF_TMPDIR /resnick/scratch/yangjunjie//gpu4pyscf-occri/54797168/
[ENV] PYSCF_MAX_MEMORY 327680
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 8
[INPUT] num. electrons = 32
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 C      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 C      0.891700000000   0.891700000000   0.891700000000 AA    1.685068785275   1.685068785275   1.685068785275 Bohr   0.0
[INPUT]  3 C      1.783400000000   1.783400000000   0.000000000000 AA    3.370137570549   3.370137570549   0.000000000000 Bohr   0.0
[INPUT]  4 C      2.675100000000   2.675100000000   0.891700000000 AA    5.055206355824   5.055206355824   1.685068785275 Bohr   0.0
[INPUT]  5 C      1.783400000000   0.000000000000   1.783400000000 AA    3.370137570549   0.000000000000   3.370137570549 Bohr   0.0
[INPUT]  6 C      2.675100000000   0.891700000000   2.675100000000 AA    5.055206355824   1.685068785275   5.055206355824 Bohr   0.0
[INPUT]  7 C      0.000000000000   1.783400000000   1.783400000000 AA    0.000000000000   3.370137570549   3.370137570549 Bohr   0.0
[INPUT]  8 C      0.891700000000   2.675100000000   2.675100000000 AA    1.685068785275   5.055206355824   5.055206355824 Bohr   0.0

nuclear repulsion = -51.1485165824969
number of shells = 24
number of NR pGTOs = 168
number of NR cGTOs = 104
basis = gth-dzvp
ecp = {}
CPU time:         1.85
lattice vectors  a1 [6.740275141, 0.000000000, 0.000000000]
                 a2 [0.000000000, 6.740275141, 0.000000000]
                 a3 [0.000000000, 0.000000000, 6.740275141]
dimension = 3
low_dim_ft_type = None
Cell volume = 306.22
exp_to_discard = 0.1
rcut = 22.07448407082675 (nimgs = [4 4 4])
lattice sum = 365 cells
precision = 1e-08
pseudo = gth-hf-rev
ke_cutoff = 100
    = [33 33 33] mesh (35937 PWs)


******** <class 'gpu4pyscf.pbc.scf.khf.KRHF'> ********
method = KRHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'gpu4pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-06
SCF conv_tol_grad = None
SCF max_cycles = 10
direct_scf = True
direct_scf_tol = 1e-13
max_memory 327680 MB (current use 1218 MB)


******** PBC SCF flags ********
N kpts = 64
kpts = [[0.         0.         0.        ]
 [0.         0.         0.23304632]
 [0.         0.         0.46609264]
 [0.         0.         0.69913896]
 [0.         0.23304632 0.        ]
 [0.         0.23304632 0.23304632]
 [0.         0.23304632 0.46609264]
 [0.         0.23304632 0.69913896]
 [0.         0.46609264 0.        ]
 [0.         0.46609264 0.23304632]
 [0.         0.46609264 0.46609264]
 [0.         0.46609264 0.69913896]
 [0.         0.69913896 0.        ]
 [0.         0.69913896 0.23304632]
 [0.         0.69913896 0.46609264]
 [0.         0.69913896 0.69913896]
 [0.23304632 0.         0.        ]
 [0.23304632 0.         0.23304632]
 [0.23304632 0.         0.46609264]
 [0.23304632 0.         0.69913896]
 [0.23304632 0.23304632 0.        ]
 [0.23304632 0.23304632 0.23304632]
 [0.23304632 0.23304632 0.46609264]
 [0.23304632 0.23304632 0.69913896]
 [0.23304632 0.46609264 0.        ]
 [0.23304632 0.46609264 0.23304632]
 [0.23304632 0.46609264 0.46609264]
 [0.23304632 0.46609264 0.69913896]
 [0.23304632 0.69913896 0.        ]
 [0.23304632 0.69913896 0.23304632]
 [0.23304632 0.69913896 0.46609264]
 [0.23304632 0.69913896 0.69913896]
 [0.46609264 0.         0.        ]
 [0.46609264 0.         0.23304632]
 [0.46609264 0.         0.46609264]
 [0.46609264 0.         0.69913896]
 [0.46609264 0.23304632 0.        ]
 [0.46609264 0.23304632 0.23304632]
 [0.46609264 0.23304632 0.46609264]
 [0.46609264 0.23304632 0.69913896]
 [0.46609264 0.46609264 0.        ]
 [0.46609264 0.46609264 0.23304632]
 [0.46609264 0.46609264 0.46609264]
 [0.46609264 0.46609264 0.69913896]
 [0.46609264 0.69913896 0.        ]
 [0.46609264 0.69913896 0.23304632]
 [0.46609264 0.69913896 0.46609264]
 [0.46609264 0.69913896 0.69913896]
 [0.69913896 0.         0.        ]
 [0.69913896 0.         0.23304632]
 [0.69913896 0.         0.46609264]
 [0.69913896 0.         0.69913896]
 [0.69913896 0.23304632 0.        ]
 [0.69913896 0.23304632 0.23304632]
 [0.69913896 0.23304632 0.46609264]
 [0.69913896 0.23304632 0.69913896]
 [0.69913896 0.46609264 0.        ]
 [0.69913896 0.46609264 0.23304632]
 [0.69913896 0.46609264 0.46609264]
 [0.69913896 0.46609264 0.69913896]
 [0.69913896 0.69913896 0.        ]
 [0.69913896 0.69913896 0.23304632]
 [0.69913896 0.69913896 0.46609264]
 [0.69913896 0.69913896 0.69913896]]
Exchange divergence treatment (exxdiv) = None
DF object = <gpu4pyscf.pbc.df.fft.FFTDF object at 0x7f1d231854c0>
cond(S) = [38043741.9840463  10221348.72975199  2734915.54528545 10221348.72800331
 10221348.73156603  8039615.90884167  1569320.74405499  8039615.90882148
  2734915.54529822  1569320.74407295   624894.20420955  1569320.74418794
 10221348.73052939  8039615.90954936  1569320.74414898  8039615.90975388
 10221348.72973424  8039615.90958748  1569320.74403177  8039615.90958692
  8039615.91136801  1003213.95190902  1155054.01666648  1003213.95190373
  1569320.74402056  1155054.01668034   999325.63675246  1155054.01666406
  8039615.91057292  1003213.95193348  1155054.01668919  1003213.95190565
  2734915.54535622  1569320.7441192    624894.20421331  1569320.74423147
  1569320.74400318  1155054.01668339   999325.6371524   1155054.01668835
   624894.20422275   999325.63724805   209084.2447918    999325.63676626
  1569320.74423652  1155054.01663821   999325.63678223  1155054.01666414
 10221348.72967745  8039615.91091068  1569320.74420504  8039615.90953217
  8039615.90981873  1003213.95193504  1155054.01665826  1003213.95188473
  1569320.7441575   1155054.01668007   999325.63677501  1155054.01665299
  8039615.91072865  1003213.95188578  1155054.01666023  1003213.95187051]
Set gradient conv threshold to 0.001
    CPU time for vj and vk                                             336.42 sec, wall time    342.99 sec, GPU time 342987.44 ms
E1 = (15.519450604381968+2.3909684868765967e-17j)  E_coul = (-11.202438046036967+2.0557639225251366e-16j)
init E= -46.8315040241519
HOMO = 0.642161396834  LUMO = 0.782143234901
    CPU time for vj and vk                                              78.05 sec, wall time     78.63 sec, GPU time  78626.66 ms
E1 = (16.28078021593268+1.848901617513932e-16j)  E_coul = (-7.450910840998368+7.713809899882098e-17j)
cycle= 1 E= -42.3186472075626  delta_E= 4.51  |g|= 3.76  |ddm|=  154
HOMO = 0.507549047265  LUMO = 0.830870586095
    CPU time for vj and vk                                              77.55 sec, wall time     78.09 sec, GPU time  78095.05 ms
E1 = (16.099065507482848+1.2602502271601132e-16j)  E_coul = (-7.363285461115614+1.6381274565855695e-16j)
cycle= 2 E= -42.4127365361297  delta_E= -0.0941  |g|= 0.792  |ddm|=  289
HOMO = 0.495122940362  LUMO = 0.850443642017
    CPU time for vj and vk                                              77.52 sec, wall time     78.08 sec, GPU time  78084.11 ms
E1 = (16.091893592551166-7.1980551440471e-17j)  E_coul = (-7.360000211558411-2.9291884011549185e-17j)
cycle= 3 E= -42.4166232015042  delta_E= -0.00389  |g|= 0.0327  |ddm|=  152
HOMO = 0.494158322458  LUMO = 0.849920485853
    CPU time for vj and vk                                              77.54 sec, wall time     78.09 sec, GPU time  78087.48 ms
E1 = (16.091482715627528-5.124134100890547e-16j)  E_coul = (-7.359594318865216-2.318209439721037e-16j)
cycle= 4 E= -42.4166281857346  delta_E= -4.98e-06  |g|= 0.00354  |ddm|= 1.87
HOMO = 0.494111442292  LUMO = 0.84993705582
    CPU time for vj and vk                                              77.54 sec, wall time     78.08 sec, GPU time  78085.10 ms
E1 = (16.091576164556372-5.042017126777097e-18j)  E_coul = (-7.359687835257461-8.99800109222588e-17j)
cycle= 5 E= -42.416628253198  delta_E= -6.75e-08  |g|= 0.000143  |ddm|= 0.305
    CPU time for SCF                                                   753.58 sec, wall time    736.16 sec, GPU time 736161.88 ms
converged SCF energy = -42.416628253198


******** <class 'gpu4pyscf.pbc.scf.khf.KRHF'> ********
method = KRHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'gpu4pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-06
SCF conv_tol_grad = None
SCF max_cycles = 10
direct_scf = True
direct_scf_tol = 1e-13
max_memory 327680 MB (current use 1432 MB)


******** PBC SCF flags ********
N kpts = 64
kpts = [[0.         0.         0.        ]
 [0.         0.         0.23304632]
 [0.         0.         0.46609264]
 [0.         0.         0.69913896]
 [0.         0.23304632 0.        ]
 [0.         0.23304632 0.23304632]
 [0.         0.23304632 0.46609264]
 [0.         0.23304632 0.69913896]
 [0.         0.46609264 0.        ]
 [0.         0.46609264 0.23304632]
 [0.         0.46609264 0.46609264]
 [0.         0.46609264 0.69913896]
 [0.         0.69913896 0.        ]
 [0.         0.69913896 0.23304632]
 [0.         0.69913896 0.46609264]
 [0.         0.69913896 0.69913896]
 [0.23304632 0.         0.        ]
 [0.23304632 0.         0.23304632]
 [0.23304632 0.         0.46609264]
 [0.23304632 0.         0.69913896]
 [0.23304632 0.23304632 0.        ]
 [0.23304632 0.23304632 0.23304632]
 [0.23304632 0.23304632 0.46609264]
 [0.23304632 0.23304632 0.69913896]
 [0.23304632 0.46609264 0.        ]
 [0.23304632 0.46609264 0.23304632]
 [0.23304632 0.46609264 0.46609264]
 [0.23304632 0.46609264 0.69913896]
 [0.23304632 0.69913896 0.        ]
 [0.23304632 0.69913896 0.23304632]
 [0.23304632 0.69913896 0.46609264]
 [0.23304632 0.69913896 0.69913896]
 [0.46609264 0.         0.        ]
 [0.46609264 0.         0.23304632]
 [0.46609264 0.         0.46609264]
 [0.46609264 0.         0.69913896]
 [0.46609264 0.23304632 0.        ]
 [0.46609264 0.23304632 0.23304632]
 [0.46609264 0.23304632 0.46609264]
 [0.46609264 0.23304632 0.69913896]
 [0.46609264 0.46609264 0.        ]
 [0.46609264 0.46609264 0.23304632]
 [0.46609264 0.46609264 0.46609264]
 [0.46609264 0.46609264 0.69913896]
 [0.46609264 0.69913896 0.        ]
 [0.46609264 0.69913896 0.23304632]
 [0.46609264 0.69913896 0.46609264]
 [0.46609264 0.69913896 0.69913896]
 [0.69913896 0.         0.        ]
 [0.69913896 0.         0.23304632]
 [0.69913896 0.         0.46609264]
 [0.69913896 0.         0.69913896]
 [0.69913896 0.23304632 0.        ]
 [0.69913896 0.23304632 0.23304632]
 [0.69913896 0.23304632 0.46609264]
 [0.69913896 0.23304632 0.69913896]
 [0.69913896 0.46609264 0.        ]
 [0.69913896 0.46609264 0.23304632]
 [0.69913896 0.46609264 0.46609264]
 [0.69913896 0.46609264 0.69913896]
 [0.69913896 0.69913896 0.        ]
 [0.69913896 0.69913896 0.23304632]
 [0.69913896 0.69913896 0.46609264]
 [0.69913896 0.69913896 0.69913896]]
Exchange divergence treatment (exxdiv) = None
DF object = <gpu4pyscf.pbc.df.fft.FFTDF object at 0x7f1d231854c0>
cond(S) = [38043741.9840463  10221348.72975199  2734915.54528545 10221348.72800331
 10221348.73156603  8039615.90884167  1569320.74405499  8039615.90882148
  2734915.54529822  1569320.74407295   624894.20420955  1569320.74418794
 10221348.73052939  8039615.90954936  1569320.74414898  8039615.90975388
 10221348.72973424  8039615.90958748  1569320.74403177  8039615.90958692
  8039615.91136801  1003213.95190902  1155054.01666648  1003213.95190373
  1569320.74402056  1155054.01668034   999325.63675246  1155054.01666406
  8039615.91057292  1003213.95193348  1155054.01668919  1003213.95190565
  2734915.54535622  1569320.7441192    624894.20421331  1569320.74423147
  1569320.74400318  1155054.01668339   999325.6371524   1155054.01668835
   624894.20422275   999325.63724805   209084.2447918    999325.63676626
  1569320.74423652  1155054.01663821   999325.63678223  1155054.01666414
 10221348.72967745  8039615.91091068  1569320.74420504  8039615.90953217
  8039615.90981873  1003213.95193504  1155054.01665826  1003213.95188473
  1569320.7441575   1155054.01668007   999325.63677501  1155054.01665299
  8039615.91072865  1003213.95188578  1155054.01666023  1003213.95187051]
Set gradient conv threshold to 0.001
    CPU time for vj and vk                                               0.05 sec, wall time      0.05 sec, GPU time     45.93 ms
Traceback (most recent call last):
  File "/resnick/groups/changroup/members/junjiey/occri-main/work/c8/main.py", line 364, in <module>
    mf.kernel(dm0)
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/gpu4pyscf/scf/hf.py", line 335, in scf
    _kernel(mf, mf.conv_tol, mf.conv_tol_grad,
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/gpu4pyscf/scf/hf.py", line 209, in _kernel
    e_tot = mf.energy_tot(dm, h1e, vhf)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/gpu4pyscf/scf/hf.py", line 309, in energy_tot
    e_tot = mf.energy_elec(dm, h1e, vhf)[0] + nuc
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/gpu4pyscf/pbc/scf/khf.py", line 158, in energy_elec
    e_coul = 1./nkpts * cp.einsum('kij,kji->', dm_kpts, vhf_kpts) * 0.5
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/cupy/linalg/_einsum.py", line 518, in einsum
    _parse_ellipsis_subscript(sub, idx, ndim=arr.ndim)
  File "/home/junjiey/anaconda3/envs/gpu4pyscf-occri/lib/python3.12/site-packages/cupy/linalg/_einsum.py", line 199, in _parse_ellipsis_subscript
    raise ValueError(
ValueError: operand 1 has more dimensions than subscripts string kji given in einstein sum, but no '...' ellipsis provided to broadcast the extra dimensions.
End time = Wed Nov 12 05:05:36 PM PST 2025
